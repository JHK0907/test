name: Deploy web to ECS Fargate

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: hkjung-web-repo
  ECS_CLUSTER: hkjung-web-cluster
  ECS_SERVICE: hkjung-web-web-service
  ECS_TASK_DEFINITION: task-definition.json
  CONTAINER_NAME: hkjung-web-container
  ECS_TASK_DEFINITION_FAMILY: hkjung-web-web-app 

jobs:
  deploy:
    name: Build, Scan & Deploy
    runs-on: ubuntu-latest

    steps:
    # 1. 소스 코드 체크아웃
    - name: Checkout
      uses: actions/checkout@v4

    # 2. AWS 인증 (OIDC)
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}

    # 3. ECR 로그인
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # 4. [원본 이미지] 빌드 및 푸시
    - name: Build, tag, and push plain image to Amazon ECR
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}-${{ github.run_number }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        # 후속 단계에서 참조할 원본 이미지 주소 출력
        echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

    # 5. 현재 ECS Task Definition 다운로드
    - name: Download task definition
      run: |
        aws ecs describe-task-definition --task-definition ${{ env.ECS_TASK_DEFINITION_FAMILY }} --query taskDefinition > ${{ env.ECS_TASK_DEFINITION }}

    # 6. 기존 설정 청소 (Clean Up)
    - name: Clean up existing Prisma Defender
      run: |
        jq 'del(.containerDefinitions[] | select(.name == "TwistlockDefender")) 
        | .containerDefinitions[].dependsOn = [] 
        | .containerDefinitions[].volumesFrom = [] 
        | .containerDefinitions[].linuxParameters.capabilities.add = ["SYS_PTRACE"]
        | (.containerDefinitions[] | select(.name == "${{ env.CONTAINER_NAME }}") | .entryPoint) = ["nginx", "-g", "daemon off;"]' ${{ env.ECS_TASK_DEFINITION }} > temp.json && mv temp.json ${{ env.ECS_TASK_DEFINITION }}

    # 7. 원본 이미지 주소를 기반으로 Task Def 렌더링
    - name: Fill in the new image ID
      id: task-def
      uses: aws-actions/amazon-ecs-render-task-definition@v1
      with:
        task-definition: ${{ env.ECS_TASK_DEFINITION }}
        container-name: ${{ env.CONTAINER_NAME }}
        image: ${{ steps.build-image.outputs.image }}

    # --- 여기서부터 [보안 이미지 병합 빌드] 과정 ---

    # 8. twistcli 다운로드 (PCC 변수명 통일)
    - name: Download and prepare twistcli
      env:
        PCC_CONSOLE_URL: ${{ secrets.PCC_CONSOLE_URL }}
        PCC_USER: ${{ secrets.PCC_USER }}
        PCC_PASS: ${{ secrets.PCC_PASS }}
      run: |
        # 1. 시크릿에 프로토콜이 없으므로 https://를 붙이고, 끝에 슬래시가 있다면 제거
        CLEAN_URL="https://$(echo "$PCC_CONSOLE_URL" | sed 's:/*$::')"
        
        # 2. curl 실행 시 프로토콜이 포함된 CLEAN_URL 사용
        curl -k -s -L -u "$PCC_USER:$PCC_PASS" \
             "$CLEAN_URL/api/v1/util/twistcli?os=linux" -o twistcli
        chmod +x twistcli


    # 9. Embed Defender 및 바이너리 추출
    - name: Embed Defender and Extract
      env:
        PCC_CONSOLE_URL: ${{ secrets.PCC_CONSOLE_URL }}
        PCC_USER: ${{ secrets.PCC_USER }}
        PCC_PASS: ${{ secrets.PCC_PASS }}
      run: |
        # 여기도 동일하게 https:// 보정
        CLEAN_URL="https://$(echo "$PCC_CONSOLE_URL" | sed 's:/*$::')"
        
        ./twistcli app-embedded embed \
          --address "$CLEAN_URL" \
          --user "$PCC_USER" \
          --password "$PCC_PASS" \
          --app-id "${{ env.ECR_REPOSITORY }}" \
          --data-folder "/tmp" \
          Dockerfile
        
        ZIP_FILE=$(ls app_embedded_embed_*.zip)
        unzip -o "$ZIP_FILE"
        tar -xzvf twistlock_defender_app_embedded.tar.gz
        chmod +x ./defender

    # 10. Dockerfile 수정 및 보안 이미지 빌드
    - name: Build Protected Image
      run: |
        # 기존 주입 코드 제거 후 최상단에 재삽입
        sed -i '/\/var\/lib\/twistlock\/fargate\/defender/d' Dockerfile
        sed -i '/FROM/a COPY defender /var/lib/twistlock/fargate/defender' Dockerfile
        sed -i '/COPY defender/a RUN chmod +x /var/lib/twistlock/fargate/defender' Dockerfile

        # 보안 이미지 빌드 (로컬 태그: protected)
        docker build -t ${{ env.ECR_REPOSITORY }}:protected .

    # 11. [보안 이미지] ECR 푸시
    - name: Tag and push protected image to ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      run: |
        COMMIT_HASH=$(git rev-parse --short HEAD)
        
        # 보안 버전 태그 생성 및 푸시
        docker tag ${{ env.ECR_REPOSITORY }}:protected $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:protected-$COMMIT_HASH
        docker tag ${{ env.ECR_REPOSITORY }}:protected $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest-protected
        
        docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:protected-$COMMIT_HASH
        docker push $ECR_REGISTRY/${{ env.ECR_REPOSITORY }}:latest-protected

    # 12. 최종 배포 (보안 이미지가 아닌, 원본 이미지 주소가 포함된 Task Def를 사용하거나 
    # 필요에 따라 protected 이미지를 참조하도록 여기서 최종 결정)
    - name: Deploy Amazon ECS task definition
      uses: aws-actions/amazon-ecs-deploy-task-definition@v2
      with:
        task-definition: ${{ steps.task-def.outputs.task-definition }}
        service: ${{ env.ECS_SERVICE }}
        cluster: ${{ env.ECS_CLUSTER }}
        wait-for-service-stability: true